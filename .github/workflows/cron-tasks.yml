name: Scheduled CRON Tasks

on:
  schedule:
    # Toutes les heures - Vérification des abonnements
    - cron: '0 * * * *'
    # Tous les jours à 2h du matin (GMT) - Tâches de nettoyage
    - cron: '0 2 * * *'
    # Tous les jours à 9h du matin - Envoi des rappels et rapports
    - cron: '0 9 * * *'
    # Toutes les 15 minutes - Vérification des commandes urgentes
    - cron: '*/15 * * * *'
    # Tous les lundis à 10h - Rapports hebdomadaires
    - cron: '0 10 * * 1'
    # Le 1er de chaque mois à 8h - Statistiques mensuelles
    - cron: '0 8 1 * *'
  
  # Permet aussi le déclenchement manuel
  workflow_dispatch:
    inputs:
      task:
        description: 'Tâche à exécuter manuellement'
        required: true
        type: choice
        options:
          - all
          - subscriptions
          - stocks
          - orders
          - cleanup
          - reports

jobs:
  # ============================================================
  # JOB 1 : Gestion des abonnements (toutes les heures)
  # ============================================================
  subscription-tasks:
    name: Gestion des abonnements
    runs-on: ubuntu-latest
    if: |
      github.event.schedule == '0 * * * *' || 
      github.event_name == 'workflow_dispatch' && 
      (github.event.inputs.task == 'all' || github.event.inputs.task == 'subscriptions')
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Installation des dépendances
        run: npm ci

      - name: Vérification des abonnements expirés
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DIRECT_URL: ${{ secrets.DIRECT_URL }}
        run: |
          curl -f -X GET \
            "${{ secrets.APP_URL }}/api/cron/check-subscriptions" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            || exit 1

      - name: Suspension des restaurants expirés
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          curl -f -X GET \
            "${{ secrets.APP_URL }}/api/cron/suspend-expired-restaurants" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            || exit 1

      - name: Nettoyage des paiements en attente
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          curl -f -X GET \
            "${{ secrets.APP_URL }}/api/cron/clean-pending-payments" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            || exit 1

  # ============================================================
  # JOB 2 : Rappels quotidiens (9h du matin)
  # ============================================================
  daily-reminders:
    name: Rappels et notifications quotidiennes
    runs-on: ubuntu-latest
    if: |
      github.event.schedule == '0 9 * * *' || 
      github.event_name == 'workflow_dispatch' && 
      (github.event.inputs.task == 'all' || github.event.inputs.task == 'subscriptions')
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Installation des dépendances
        run: npm ci

      - name: Envoi des rappels d'abonnement
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          curl -f -X GET \
            "${{ secrets.APP_URL }}/api/cron/send-subscription-reminders" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            || exit 1

      - name: Envoi des alertes de stock bas
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          curl -f -X GET \
            "${{ secrets.APP_URL }}/api/cron/send-stock-alerts" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            || exit 1

      - name: Envoi des rapports quotidiens
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          curl -f -X GET \
            "${{ secrets.APP_URL }}/api/cron/send-daily-reports" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            || exit 1

  # ============================================================
  # JOB 3 : Gestion des commandes (toutes les 15 minutes)
  # ============================================================
  order-monitoring:
    name: Surveillance des commandes
    runs-on: ubuntu-latest
    if: |
      github.event.schedule == '*/15 * * * *' || 
      github.event_name == 'workflow_dispatch' && 
      (github.event.inputs.task == 'all' || github.event.inputs.task == 'orders')
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Installation des dépendances
        run: npm ci

      - name: Annulation des commandes abandonnées
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          curl -f -X GET \
            "${{ secrets.APP_URL }}/api/cron/cancel-abandoned-orders" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            || exit 1

      - name: Rappels commandes non traitées
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          curl -f -X GET \
            "${{ secrets.APP_URL }}/api/cron/alert-pending-orders" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            || exit 1

  # ============================================================
  # JOB 4 : Tâches de nettoyage (2h du matin)
  # ============================================================
  cleanup-tasks:
    name: Nettoyage et maintenance
    runs-on: ubuntu-latest
    if: |
      github.event.schedule == '0 2 * * *' || 
      github.event_name == 'workflow_dispatch' && 
      (github.event.inputs.task == 'all' || github.event.inputs.task == 'cleanup')
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Installation des dépendances
        run: npm ci

      - name: Vérification des stocks
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          curl -f -X GET \
            "${{ secrets.APP_URL }}/api/cron/verify-stock-consistency" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            || exit 1

      - name: Archivage des anciennes commandes
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          curl -f -X GET \
            "${{ secrets.APP_URL }}/api/cron/archive-old-orders" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            || exit 1

      - name: Nettoyage des logs système
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          curl -f -X GET \
            "${{ secrets.APP_URL }}/api/cron/clean-system-logs" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            || exit 1

      - name: Nettoyage des sessions inactives
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          curl -f -X GET \
            "${{ secrets.APP_URL }}/api/cron/clean-inactive-sessions" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            || exit 1

  # ============================================================
  # JOB 5 : Rapports hebdomadaires (lundi 10h)
  # ============================================================
  weekly-reports:
    name: Rapports hebdomadaires
    runs-on: ubuntu-latest
    if: |
      github.event.schedule == '0 10 * * 1' || 
      github.event_name == 'workflow_dispatch' && 
      (github.event.inputs.task == 'all' || github.event.inputs.task == 'reports')
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Installation des dépendances
        run: npm ci

      - name: Envoi des rapports hebdomadaires
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          curl -f -X GET \
            "${{ secrets.APP_URL }}/api/cron/send-weekly-reports" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            || exit 1

      - name: Digest des notifications non lues
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          curl -f -X GET \
            "${{ secrets.APP_URL }}/api/cron/send-notification-digest" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            || exit 1

  # ============================================================
  # JOB 6 : Statistiques mensuelles (1er du mois à 8h)
  # ============================================================
  monthly-stats:
    name: Statistiques mensuelles
    runs-on: ubuntu-latest
    if: |
      github.event.schedule == '0 8 1 * *' || 
      github.event_name == 'workflow_dispatch' && 
      (github.event.inputs.task == 'all' || github.event.inputs.task == 'reports')
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Installation des dépendances
        run: npm ci

      - name: Calcul des statistiques mensuelles
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          curl -f -X GET \
            "${{ secrets.APP_URL }}/api/cron/calculate-monthly-stats" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            || exit 1

      - name: Envoi des rapports mensuels
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          curl -f -X GET \
            "${{ secrets.APP_URL }}/api/cron/send-monthly-reports" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            || exit 1