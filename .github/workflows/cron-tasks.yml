name: Scheduled CRON Tasks

on:
  schedule:
    # Toutes les heures — Vérification des abonnements + suspension
    - cron: '0 * * * *'
    # Toutes les 15 minutes — Surveillance des commandes
    - cron: '*/15 * * * *'
    # Tous les jours à 2h (UTC) — Nettoyage + archivage + stocks
    - cron: '0 2 * * *'
    # Tous les jours à 7h (UTC) — Rappels abonnements + rapports quotidiens
    - cron: '0 7 * * *'

  # Déclenchement manuel depuis l'onglet Actions de GitHub
  workflow_dispatch:
    inputs:
      task:
        description: 'Tâche à exécuter manuellement'
        required: true
        type: choice
        options:
          - all
          - subscriptions
          - orders
          - cleanup
          - reminders

# ─────────────────────────────────────────────────────────────────────────────
# IMPORTANT — Architecture des jobs
# ─────────────────────────────────────────────────────────────────────────────
# Ces jobs appellent des routes HTTP sur l'app déployée (APP_URL).
# Ils n'ont PAS besoin de checkout / npm ci / prisma generate.
# La seule étape nécessaire est un appel curl avec le CRON_SECRET.
#
# L'erreur "prisma generate / DATABASE_URL" venait des jobs qui faisaient
# npm ci inutilement. Tout le bloc node.js a été supprimé.
# ─────────────────────────────────────────────────────────────────────────────

jobs:

  # ============================================================
  # JOB 1 — Abonnements (toutes les heures)
  # check-subscriptions → suspend-expired-restaurants
  # ============================================================
  subscription-tasks:
    name: Gestion des abonnements
    runs-on: ubuntu-latest
    if: |
      github.event.schedule == '0 * * * *' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.task == 'all' || github.event.inputs.task == 'subscriptions'))

    steps:
      - name: Vérification des abonnements expirés
        run: |
          curl -f -X GET \
            "${{ secrets.APP_URL }}/api/cron/check-subscriptions" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}"

      # Doit tourner APRÈS check-subscriptions (les abonnements sont d'abord
      # passés en "expired", puis ce CRON désactive les restaurants concernés)
      - name: Suspension des restaurants expirés
        run: |
          curl -f -X GET \
            "${{ secrets.APP_URL }}/api/cron/suspend-expired-restaurants" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}"

  # ============================================================
  # JOB 2 — Surveillance des commandes (toutes les 15 minutes)
  # cancel-abandoned-orders → alert-pending-orders
  # ============================================================
  order-monitoring:
    name: Surveillance des commandes
    runs-on: ubuntu-latest
    if: |
      github.event.schedule == '*/15 * * * *' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.task == 'all' || github.event.inputs.task == 'orders'))

    steps:
      - name: Annulation des commandes abandonnées (> 4h en pending)
        run: |
          curl -f -X GET \
            "${{ secrets.APP_URL }}/api/cron/cancel-abandoned-orders" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}"

      - name: Alerte commandes non traitées (> 15min en pending)
        run: |
          curl -f -X GET \
            "${{ secrets.APP_URL }}/api/cron/alert-pending-orders" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}"

  # ============================================================
  # JOB 3 — Nettoyage et maintenance (2h du matin UTC)
  # stocks → archivage → logs
  # ============================================================
  cleanup-tasks:
    name: Nettoyage et maintenance
    runs-on: ubuntu-latest
    if: |
      github.event.schedule == '0 2 * * *' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.task == 'all' || github.event.inputs.task == 'cleanup'))

    steps:
      - name: Cohérence des stocks (désactive/réactive selon quantity)
        run: |
          curl -f -X GET \
            "${{ secrets.APP_URL }}/api/cron/verify-stock-consistency" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}"

      - name: Archivage des commandes > 90 jours
        run: |
          curl -f -X GET \
            "${{ secrets.APP_URL }}/api/cron/archive-old-orders" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}"

      - name: Nettoyage des logs système (info/warning > 30j, error > 90j)
        run: |
          curl -f -X GET \
            "${{ secrets.APP_URL }}/api/cron/clean-system-logs" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}"

  # ============================================================
  # JOB 4 — Rappels et rapports quotidiens (7h UTC)
  # send-subscription-reminders → send-daily-reports
  # ============================================================
  daily-reminders:
    name: Rappels et rapports quotidiens
    runs-on: ubuntu-latest
    if: |
      github.event.schedule == '0 7 * * *' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.task == 'all' || github.event.inputs.task == 'reminders'))

    steps:
      - name: Rappels d'expiration d'abonnement (J-7, J-3, J-1)
        # Anti-doublon intégré : n'envoie qu'une fois par jour par emailType
        run: |
          curl -f -X GET \
            "${{ secrets.APP_URL }}/api/cron/send-subscription-reminders" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}"

#      - name: Rapport brut d'activité du jour (calcul interne)
#        # Calcule et expose les stats du jour — utilisé comme source de données
#        # par send-daily-reports et par le dashboard SuperAdmin
#        run: |
#          curl -f -X GET \
#            "${{ secrets.APP_URL }}/api/cron/daily-report" \
#            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}"

      - name: Rapports d'activité quotidiens par email (admin de chaque restaurant)
        # Envoie le rapport formaté par email à l'admin de chaque restaurant actif
        run: |
          curl -f -X GET \
            "${{ secrets.APP_URL }}/api/cron/send-daily-reports" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}"

  # ============================================================
  # JOB 5 — Rapports hebdomadaires et mensuels (post-MVP)
  #
  # ⚠️  Ces routes n'existent pas encore dans le codebase.
  #     Ce job est désactivé jusqu'à leur implémentation.
  #     Pour réactiver : décommenter le bloc et supprimer le job vide.
  # ============================================================
  # future-reports:
  #   name: Rapports hebdo / mensuels (post-MVP)
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Rapport hebdomadaire (lundi 10h)
  #       run: |
  #         curl -f -X GET \
  #           "${{ secrets.APP_URL }}/api/cron/send-weekly-reports" \
  #           -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}"
  #
  #     - name: Stats mensuelles (1er du mois 8h)
  #       run: |
  #         curl -f -X GET \
  #           "${{ secrets.APP_URL }}/api/cron/calculate-monthly-stats" \
  #           -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}"
  #
  #     - name: Envoi des rapports mensuels
  #       run: |
  #         curl -f -X GET \
  #           "${{ secrets.APP_URL }}/api/cron/send-monthly-reports" \
  #           -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}"
  #
  #     - name: Digest des notifications non lues
  #       run: |
  #         curl -f -X GET \
  #           "${{ secrets.APP_URL }}/api/cron/send-notification-digest" \
  #           -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}"