generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================================
// ENUMS
// ============================================================

enum UserRole {
  admin
  kitchen

  @@map("user_role")
}

enum OrderStatus {
  pending
  preparing
  ready
  delivered
  cancelled

  @@map("order_status")
}

enum PaymentStatus {
  pending
  paid
  failed
  refunded

  @@map("payment_status")
}

enum PaymentMethod {
  mobile_money
  cash

  @@map("payment_method")
}

enum PaymentTiming {
  before_meal
  after_meal

  @@map("payment_timing")
}

enum StockMovementType {
  manual_in
  manual_out
  adjustment
  order_out

  @@map("stock_movement_type")
}

enum TicketStatus {
  open
  in_progress
  resolved
  closed

  @@map("ticket_status")
}

enum TicketPriority {
  low
  medium
  high
  urgent

  @@map("ticket_priority")
}

enum LogLevel {
  info
  warning
  error
  critical

  @@map("log_level")
}

// ============================================================
// MODELS
// ============================================================

model Restaurant {
  id              String   @id @default(uuid()) @db.Uuid
  name            String
  slug            String   @unique
  phone           String?
  address         String?
  logoUrl         String?  @map("logo_url")
  coverImageUrl String?  @map("cover_image_url")
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  users          RestaurantUser[]
  tables         Table[]
  categories     Category[]
  products       Product[]
  stocks         Stock[]
  orders         Order[]
  payments       Payment[]
  stockMovements StockMovement[]
  dailyStats     DailyStats[]
  supportTickets SupportTicket[]

  @@map("restaurants")
}

model RestaurantUser {
  id           String   @id @default(uuid()) @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  restaurantId String   @map("restaurant_id") @db.Uuid
  role         UserRole
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@unique([userId, restaurantId])
  @@index([userId])
  @@map("restaurant_users")
}

model Table {
  id           String   @id @default(uuid()) @db.Uuid
  restaurantId String   @map("restaurant_id") @db.Uuid
  number       Int
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  orders     Order[]

  @@unique([restaurantId, number])
  @@index([restaurantId, isActive])
  @@map("tables")
}

model Category {
  id           String   @id @default(uuid()) @db.Uuid
  restaurantId String   @map("restaurant_id") @db.Uuid
  name         String
  description  String?
  position     Int      @default(0)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  products   Product[]

  @@map("categories")
}

model Product {
  id           String   @id @default(uuid()) @db.Uuid
  restaurantId String   @map("restaurant_id") @db.Uuid
  categoryId   String?  @map("category_id") @db.Uuid
  name         String
  description  String?
  price        Int // Prix en FCFA (entier uniquement)
  imageUrl     String?  @map("image_url")
  isAvailable  Boolean  @default(true) @map("is_available")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  restaurant     Restaurant      @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  category       Category?       @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  stock          Stock?
  orderItems     OrderItem[]
  stockMovements StockMovement[]

  @@index([restaurantId, categoryId])
  @@index([restaurantId, isAvailable])
  @@map("products")
}

model Stock {
  id             String   @id @default(uuid()) @db.Uuid
  restaurantId   String   @map("restaurant_id") @db.Uuid
  productId      String   @unique @map("product_id") @db.Uuid
  quantity       Int      @default(0)
  alertThreshold Int      @default(5) @map("alert_threshold")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  product    Product    @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([restaurantId, productId])
  @@index([productId])
  @@map("stocks")
}

model Order {
  id           String      @id @default(uuid()) @db.Uuid
  restaurantId String      @map("restaurant_id") @db.Uuid
  tableId      String?     @map("table_id") @db.Uuid
  orderNumber  String?     @map("order_number")
  customerName String?     @map("customer_name")
  status       OrderStatus @default(pending)
  totalAmount  Int         @default(0) @map("total_amount") // Montant en FCFA (entier)
  notes        String?
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")

  // Relations
  restaurant     Restaurant      @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  table          Table?          @relation(fields: [tableId], references: [id], onDelete: SetNull)
  orderItems     OrderItem[]
  payments       Payment[]
  stockMovements StockMovement[]

  @@unique([restaurantId, orderNumber])
  @@index([restaurantId, status])
  @@index([restaurantId, createdAt(sort: Desc)])
  @@map("orders")
}

model OrderItem {
  id          String @id @default(uuid()) @db.Uuid
  orderId     String @map("order_id") @db.Uuid
  productId   String @map("product_id") @db.Uuid
  productName String @map("product_name")
  quantity    Int
  unitPrice   Int    @map("unit_price") // Prix unitaire en FCFA au moment de la commande

  // Relations
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@map("order_items")
}

model Payment {
  id            String        @id @default(uuid()) @db.Uuid
  restaurantId  String        @map("restaurant_id") @db.Uuid
  orderId       String        @map("order_id") @db.Uuid
  amount        Int // Montant en FCFA (entier)
  method        PaymentMethod
  status        PaymentStatus @default(pending)
  timing        PaymentTiming
  transactionId String?       @map("transaction_id")
  phoneNumber   String?       @map("phone_number")
  errorMessage  String?       @map("error_message")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  // Relations
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  order      Order      @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@map("payments")
}

model StockMovement {
  id           String            @id @default(uuid()) @db.Uuid
  restaurantId String            @map("restaurant_id") @db.Uuid
  productId    String            @map("product_id") @db.Uuid
  userId       String            @map("user_id") @db.Uuid
  type         StockMovementType
  quantity     Int
  previousQty  Int               @map("previous_qty")
  newQty       Int               @map("new_qty")
  reason       String?
  orderId      String?           @map("order_id") @db.Uuid
  createdAt    DateTime          @default(now()) @map("created_at")

  // Relations
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  product    Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  order      Order?     @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@index([restaurantId, productId])
  @@index([restaurantId, createdAt(sort: Desc)])
  @@map("stock_movements")
}


// Table Support Tickets
model SupportTicket {
  id           String         @id @default(uuid()) @db.Uuid
  restaurantId String         @map("restaurant_id") @db.Uuid
  userId       String         @map("user_id") @db.Uuid
  
  // Contenu
  subject      String
  description  String
  status       TicketStatus   @default(open)
  priority     TicketPriority @default(medium)
  
  // Méta
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")
  resolvedAt   DateTime?      @map("resolved_at")
  
  // Relations
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  messages   TicketMessage[]

  @@index([restaurantId, status])
  @@index([status, priority])
  @@map("support_tickets")
}

// Messages du ticket
model TicketMessage {
  id       String   @id @default(uuid()) @db.Uuid
  ticketId String   @map("ticket_id") @db.Uuid
  userId   String   @map("user_id") @db.Uuid
  message  String
  isAdmin  Boolean  @default(false) @map("is_admin")
  
  createdAt DateTime @default(now()) @map("created_at")
  
  // Relations
  ticket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@map("ticket_messages")
}

// Table optionnelle pour cache des stats (performance)
model DailyStats {
  id           String   @id @default(uuid()) @db.Uuid
  date         DateTime @db.Date
  restaurantId String?  @map("restaurant_id") @db.Uuid
  ordersCount  Int      @default(0) @map("orders_count")
  revenue      Int      @default(0)
  avgOrderValue Int     @default(0) @map("avg_order_value")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  restaurant Restaurant? @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@unique([date, restaurantId])
  @@index([date])
  @@index([restaurantId, date])
  @@map("daily_stats")
}

// Table Logs Système
model SystemLog {
  id        String   @id @default(uuid()) @db.Uuid
  level     LogLevel
  action    String   // Ex: "restaurant_created", "order_failed"
  message   String
  userId    String?  @map("user_id") @db.Uuid
  metadata  Json?    // Données additionnelles
  createdAt DateTime @default(now()) @map("created_at")

  @@index([level, createdAt(sort: Desc)])
  @@index([action])
  @@map("system_logs")
}
