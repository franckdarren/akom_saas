generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================================
// ENUMS
// ============================================================

enum UserRole {
  admin
  kitchen

  @@map("user_role")
}

enum OrderStatus {
  pending
  preparing
  ready
  delivered
  cancelled

  @@map("order_status")
}

enum PaymentStatus {
  pending
  paid
  failed
  refunded

  @@map("payment_status")
}

enum PaymentMethod {
  mobile_money
  cash

  @@map("payment_method")
}

enum PaymentTiming {
  before_meal
  after_meal

  @@map("payment_timing")
}

enum StockMovementType {
  manual_in
  manual_out
  adjustment
  order_out

  @@map("stock_movement_type")
}

// ============================================================
// MODELS
// ============================================================

model Restaurant {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  slug      String   @unique
  phone     String?
  address   String?
  logoUrl   String?  @map("logo_url")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  users          RestaurantUser[]
  tables         Table[]
  categories     Category[]
  products       Product[]
  stocks         Stock[]
  orders         Order[]
  payments       Payment[]
  stockMovements StockMovement[]

  @@map("restaurants")
}

model RestaurantUser {
  id           String   @id @default(uuid()) @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  restaurantId String   @map("restaurant_id") @db.Uuid
  role         UserRole
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@unique([userId, restaurantId])
  @@index([userId])
  @@map("restaurant_users")
}

model Table {
  id           String   @id @default(uuid()) @db.Uuid
  restaurantId String   @map("restaurant_id") @db.Uuid
  number       Int
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  orders     Order[]

  @@unique([restaurantId, number])
  @@index([restaurantId, isActive])
  @@map("tables")
}

model Category {
  id           String   @id @default(uuid()) @db.Uuid
  restaurantId String   @map("restaurant_id") @db.Uuid
  name         String
  description  String?
  position     Int      @default(0)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  products   Product[]

  @@map("categories")
}

model Product {
  id           String   @id @default(uuid()) @db.Uuid
  restaurantId String   @map("restaurant_id") @db.Uuid
  categoryId   String?  @map("category_id") @db.Uuid
  name         String
  description  String?
  price        Int // Prix en FCFA (entier uniquement)
  imageUrl     String?  @map("image_url")
  isAvailable  Boolean  @default(true) @map("is_available")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  restaurant     Restaurant      @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  category       Category?       @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  stock          Stock?
  orderItems     OrderItem[]
  stockMovements StockMovement[]

  @@index([restaurantId, categoryId])
  @@index([restaurantId, isAvailable])
  @@map("products")
}

model Stock {
  id             String   @id @default(uuid()) @db.Uuid
  restaurantId   String   @map("restaurant_id") @db.Uuid
  productId      String   @unique @map("product_id") @db.Uuid
  quantity       Int      @default(0)
  alertThreshold Int      @default(5) @map("alert_threshold")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  product    Product    @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([restaurantId, productId])
  @@index([productId])
  @@map("stocks")
}

model Order {
  id           String      @id @default(uuid()) @db.Uuid
  restaurantId String      @map("restaurant_id") @db.Uuid
  tableId      String?     @map("table_id") @db.Uuid
  orderNumber  String      @map("order_number")
  customerName String?     @map("customer_name")
  status       OrderStatus @default(pending)
  totalAmount  Int         @default(0) @map("total_amount") // Montant en FCFA (entier)
  notes        String?
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")

  // Relations
  restaurant     Restaurant      @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  table          Table?          @relation(fields: [tableId], references: [id], onDelete: SetNull)
  orderItems     OrderItem[]
  payments       Payment[]
  stockMovements StockMovement[]

  @@unique([restaurantId, orderNumber])
  @@index([restaurantId, status])
  @@index([restaurantId, createdAt(sort: Desc)])
  @@map("orders")
}

model OrderItem {
  id          String @id @default(uuid()) @db.Uuid
  orderId     String @map("order_id") @db.Uuid
  productId   String @map("product_id") @db.Uuid
  productName String @map("product_name")
  quantity    Int
  unitPrice   Int    @map("unit_price") // Prix unitaire en FCFA au moment de la commande

  // Relations
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@map("order_items")
}

model Payment {
  id            String        @id @default(uuid()) @db.Uuid
  restaurantId  String        @map("restaurant_id") @db.Uuid
  orderId       String        @map("order_id") @db.Uuid
  amount        Int // Montant en FCFA (entier)
  method        PaymentMethod
  status        PaymentStatus @default(pending)
  timing        PaymentTiming
  transactionId String?       @map("transaction_id")
  phoneNumber   String?       @map("phone_number")
  errorMessage  String?       @map("error_message")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  // Relations
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  order      Order      @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@map("payments")
}

model StockMovement {
  id           String            @id @default(uuid()) @db.Uuid
  restaurantId String            @map("restaurant_id") @db.Uuid
  productId    String            @map("product_id") @db.Uuid
  userId       String            @map("user_id") @db.Uuid
  type         StockMovementType
  quantity     Int
  previousQty  Int               @map("previous_qty")
  newQty       Int               @map("new_qty")
  reason       String?
  orderId      String?           @map("order_id") @db.Uuid
  createdAt    DateTime          @default(now()) @map("created_at")

  // Relations
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  product    Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  order      Order?     @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@index([restaurantId, productId])
  @@index([restaurantId, createdAt(sort: Desc)])
  @@map("stock_movements")
}
