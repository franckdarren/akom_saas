generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================
// ENUMS
// ============================================================

enum UserRole {
  admin
  kitchen

  @@map("user_role")
}

enum OrderStatus {
  pending
  preparing
  ready
  delivered
  cancelled

  @@map("order_status")
}

enum PaymentStatus {
  pending
  paid
  failed
  refunded

  @@map("payment_status")
}

enum PaymentMethod {
  mobile_money
  cash

  @@map("payment_method")
}

enum PaymentTiming {
  before_meal
  after_meal

  @@map("payment_timing")
}

enum StockMovementType {
  manual_in
  manual_out
  adjustment
  order_out

  @@map("stock_movement_type")
}

enum TicketStatus {
  open
  in_progress
  resolved
  closed

  @@map("ticket_status")
}

enum TicketPriority {
  low
  medium
  high
  urgent

  @@map("ticket_priority")
}

enum LogLevel {
  info
  warning
  error
  critical

  @@map("log_level")
}

enum PermissionResource {
  restaurants
  users
  menu
  categories
  products
  tables
  orders
  stocks
  payments
  stats
  roles

  @@map("permission_resource")
}

enum PermissionAction {
  create
  read
  update
  delete
  manage // Acc√®s complet √† la ressource

  @@map("permission_action")
}

enum InvitationStatus {
  pending // En attente d'acceptation
  accepted // Accept√©e
  expired // Expir√©e (apr√®s 7 jours)
  revoked // R√©voqu√©e par l'admin

  @@map("invitation_status")
}

enum SubscriptionPlan {
  starter
  business
  premium

  @@map("subscription_plan")
}

enum SubscriptionStatus {
  trial         // P√©riode d'essai active
  active        // Abonnement actif et pay√©
  expired       // Abonnement expir√©
  suspended     // Suspendu manuellement par admin
  cancelled     // Annul√© par le client

  @@map("subscription_status")
}

enum SubscriptionPaymentMethod {
  manual        // Virement/d√©p√¥t manuel (MVP)
  mobile_money  // Airtel/Moov (V2)
  card          // Carte bancaire (futur)

  @@map("subscription_payment_method")
}

enum SubscriptionPaymentStatus {
  pending       // En attente de validation
  confirmed     // Confirm√© et valid√©
  failed        // √âchou√©
  refunded      // Rembours√©

  @@map("subscription_payment_status")
}

// ============================================================
// MODELS
// ============================================================

model Restaurant {
  id            String   @id @default(uuid()) @db.Uuid
  name          String
  slug          String   @unique
  phone         String?
  address       String?
  logoUrl       String?  @map("logo_url")
  coverImageUrl String?  @map("cover_image_url")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Identifiants eBilling (pour mod√®le d√©centralis√© - optionnel)
  ebillingUsername   String?  @map("ebilling_username")
  ebillingSharedKey  String?  @map("ebilling_shared_key")
  ebillingConfigured Boolean  @default(false) @map("ebilling_configured")

  // üÜï Coordonn√©es bancaires pour redistribution
  bankAccountNumber  String? @map("bank_account_number")
  bankName           String? @map("bank_name")
  bankAccountHolder  String? @map("bank_account_holder")
  bankIban           String? @map("bank_iban")
  bankSwiftCode      String? @map("bank_swift_code")
  
  // üÜï Mobile Money pour redistribution
  mobileMoneyNumber   String? @map("mobile_money_number") // Format: 074123456
  mobileMoneyOperator String? @map("mobile_money_operator") // airtel ou moov
  mobileMoneyHolder   String? @map("mobile_money_holder")
  
  // üÜï Pr√©f√©rences de redistribution
  preferredRedistributionMethod String  @default("mobile_money") @map("preferred_redistribution_method")
  redistributionFrequency       String  @default("weekly") @map("redistribution_frequency")
  redistributionDayOfWeek       Int?    @default(5) @map("redistribution_day_of_week") // 1-7, 5=Vendredi
  minRedistributionAmount       Int     @default(10000) @map("min_redistribution_amount")


  // Relations
  users          RestaurantUser[]
  tables         Table[]
  categories     Category[]
  families       Family[]  
  products       Product[]
  stocks         Stock[]
  orders         Order[]
  payments       Payment[]
  stockMovements StockMovement[]
  dailyStats     DailyStats[]
  supportTickets SupportTicket[]
  roles          Role[]
  invitations    Invitation[]
  subscription           Subscription?
  subscriptionPayments   SubscriptionPayment[]
  subscriptionEmailLogs  SubscriptionEmailLog[]

  @@map("restaurants")
}

model RestaurantUser {
  id           String    @id @default(uuid()) @db.Uuid
  userId       String    @map("user_id") @db.Uuid
  restaurantId String    @map("restaurant_id") @db.Uuid
  role         UserRole?
  createdAt    DateTime  @default(now()) @map("created_at")
  roleId       String?   @map("role_id") @db.Uuid

  // Relations
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  customRole Role?      @relation(fields: [roleId], references: [id], onDelete: SetNull)

  @@unique([userId, restaurantId])
  @@index([userId])
  @@map("restaurant_users")
}

model Table {
  id           String   @id @default(uuid()) @db.Uuid
  restaurantId String   @map("restaurant_id") @db.Uuid
  number       Int
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  orders     Order[]

  @@unique([restaurantId, number])
  @@index([restaurantId, isActive])
  @@map("tables")
}

model Category {
  id           String   @id @default(uuid()) @db.Uuid
  restaurantId String   @map("restaurant_id") @db.Uuid
  name         String
  description  String?
  position     Int      @default(0)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  products   Product[]
  families   Family[] 

  @@map("categories")
}

model Family {
  id           String   @id @default(uuid()) @db.Uuid
  restaurantId String   @map("restaurant_id") @db.Uuid
  categoryId   String   @map("category_id") @db.Uuid
  name         String
  description  String?
  position     Int      @default(0)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  category   Category   @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  products   Product[]

  // Index pour la performance et l'unicit√©
  @@unique([restaurantId, categoryId, name])
  @@index([restaurantId])
  @@index([categoryId])
  @@index([restaurantId, categoryId, position])
  @@map("families")
}

model Product {
  id           String   @id @default(uuid()) @db.Uuid
  restaurantId String   @map("restaurant_id") @db.Uuid
  categoryId   String?  @map("category_id") @db.Uuid
  familyId     String?  @map("family_id") @db.Uuid  
  name         String
  description  String?
  price        Int // Prix en FCFA (entier uniquement)
  imageUrl     String?  @map("image_url")
  isAvailable  Boolean  @default(true) @map("is_available")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  restaurant     Restaurant      @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  category       Category?       @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  family         Family?         @relation(fields: [familyId], references: [id], onDelete: SetNull) 
  stock          Stock?
  orderItems     OrderItem[]
  stockMovements StockMovement[]

  @@index([restaurantId, categoryId])
  @@index([restaurantId, familyId]) 
  @@index([restaurantId, isAvailable])
  @@map("products")
}

model Stock {
  id             String   @id @default(uuid()) @db.Uuid
  restaurantId   String   @map("restaurant_id") @db.Uuid
  productId      String   @unique @map("product_id") @db.Uuid
  quantity       Int      @default(0)
  alertThreshold Int      @default(5) @map("alert_threshold")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  product    Product    @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([restaurantId, productId])
  @@index([productId])
  @@map("stocks")
}

model Order {
  id           String      @id @default(uuid()) @db.Uuid
  restaurantId String      @map("restaurant_id") @db.Uuid
  tableId      String?     @map("table_id") @db.Uuid
  orderNumber  String?     @map("order_number")
  customerName String?     @map("customer_name")
  status       OrderStatus @default(pending)
  totalAmount  Int         @default(0) @map("total_amount") // Montant en FCFA (entier)
  notes        String?
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")

  // Relations
  restaurant     Restaurant      @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  table          Table?          @relation(fields: [tableId], references: [id], onDelete: SetNull)
  orderItems     OrderItem[]
  payments       Payment[]
  stockMovements StockMovement[]

  @@unique([restaurantId, orderNumber])
  @@index([restaurantId, status])
  @@index([restaurantId, createdAt(sort: Desc)])
  @@map("orders")
}

model OrderItem {
  id          String @id @default(uuid()) @db.Uuid
  orderId     String @map("order_id") @db.Uuid
  productId   String @map("product_id") @db.Uuid
  productName String @map("product_name")
  quantity    Int
  unitPrice   Int    @map("unit_price") // Prix unitaire en FCFA au moment de la commande

  // Relations
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@map("order_items")
}

model Payment {
  id            String        @id @default(uuid()) @db.Uuid
  restaurantId  String        @map("restaurant_id") @db.Uuid
  orderId       String        @map("order_id") @db.Uuid
  amount        Int // Montant TOTAL pay√© par le client (commande + commission + frais)
  method        PaymentMethod
  status        PaymentStatus @default(pending)
  timing        PaymentTiming
  transactionId String?       @map("transaction_id")
  phoneNumber   String?       @map("phone_number")
  errorMessage  String?       @map("error_message")
  
  // üÜï NOUVEAUX CHAMPS pour le mod√®le centralis√©
  metadata             Json?     // D√©composition: {restaurantAmount, akomCommission, transactionFees, totalPaid}
  redistributedAt      DateTime? @map("redistributed_at") // Date de reversement au restaurant
  redistributionMethod String?   @map("redistribution_method") // mobile_money, bank_transfer, cash
  redistributionRef    String?   @map("redistribution_ref") // R√©f√©rence transaction de redistribution
  
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  // Relations
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  order      Order      @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([restaurantId, redistributedAt]) // üÜï Index pour requ√™tes de redistribution
  @@index([restaurantId, status, redistributedAt]) // üÜï Index composite pour stats
  @@map("payments")
}

model StockMovement {
  id           String            @id @default(uuid()) @db.Uuid
  restaurantId String            @map("restaurant_id") @db.Uuid
  productId    String            @map("product_id") @db.Uuid
  userId       String            @map("user_id") @db.Uuid
  type         StockMovementType
  quantity     Int
  previousQty  Int               @map("previous_qty")
  newQty       Int               @map("new_qty")
  reason       String?
  orderId      String?           @map("order_id") @db.Uuid
  createdAt    DateTime          @default(now()) @map("created_at")

  // Relations
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  product    Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  order      Order?     @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@index([restaurantId, productId])
  @@index([restaurantId, createdAt(sort: Desc)])
  @@map("stock_movements")
}

// Table Support Tickets
model SupportTicket {
  id           String @id @default(uuid()) @db.Uuid
  restaurantId String @map("restaurant_id") @db.Uuid
  userId       String @map("user_id") @db.Uuid

  // Contenu
  subject     String
  description String
  status      TicketStatus   @default(open)
  priority    TicketPriority @default(medium)

  // M√©ta
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  resolvedAt DateTime? @map("resolved_at")

  // Relations
  restaurant Restaurant      @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  messages   TicketMessage[]

  @@index([restaurantId, status])
  @@index([status, priority])
  @@map("support_tickets")
}

// Messages du ticket
model TicketMessage {
  id       String  @id @default(uuid()) @db.Uuid
  ticketId String  @map("ticket_id") @db.Uuid
  userId   String  @map("user_id") @db.Uuid
  message  String
  isAdmin  Boolean @default(false) @map("is_admin")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  ticket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@map("ticket_messages")
}

// Table optionnelle pour cache des stats (performance)
model DailyStats {
  id            String   @id @default(uuid()) @db.Uuid
  date          DateTime @db.Date
  restaurantId  String?  @map("restaurant_id") @db.Uuid
  ordersCount   Int      @default(0) @map("orders_count")
  revenue       Int      @default(0)
  avgOrderValue Int      @default(0) @map("avg_order_value")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  restaurant Restaurant? @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@unique([date, restaurantId])
  @@index([date])
  @@index([restaurantId, date])
  @@map("daily_stats")
}

// Table Logs Syst√®me
model SystemLog {
  id        String   @id @default(uuid()) @db.Uuid
  level     LogLevel
  action    String // Ex: "restaurant_created", "order_failed"
  message   String
  userId    String?  @map("user_id") @db.Uuid
  metadata  Json? // Donn√©es additionnelles
  createdAt DateTime @default(now()) @map("created_at")

  @@index([level, createdAt(sort: Desc)])
  @@index([action])
  @@map("system_logs")
}

model Role {
  id           String   @id @default(uuid()) @db.Uuid
  restaurantId String   @map("restaurant_id") @db.Uuid
  name         String
  description  String?
  isSystem     Boolean  @default(false) @map("is_system") // true pour admin et kitchen
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  restaurant      Restaurant       @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  permissions     RolePermission[]
  restaurantUsers RestaurantUser[]
  invitations     Invitation[]

  @@unique([restaurantId, name])
  @@index([restaurantId, isActive])
  @@map("roles")
}

model Permission {
  id          String             @id @default(uuid()) @db.Uuid
  resource    PermissionResource
  action      PermissionAction
  name        String // Nom lisible: "Cr√©er des produits"
  description String? // Description d√©taill√©e
  category    String // Pour regrouper dans l'UI: "Menu", "Commandes", etc.
  isSystem    Boolean            @default(true) @map("is_system")

  // Relations
  rolePermissions RolePermission[]

  @@unique([resource, action])
  @@index([category])
  @@map("permissions")
}

model RolePermission {
  id           String   @id @default(uuid()) @db.Uuid
  roleId       String   @map("role_id") @db.Uuid
  permissionId String   @map("permission_id") @db.Uuid
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@map("role_permissions")
}

model Invitation {
  id           String           @id @default(uuid()) @db.Uuid
  restaurantId String           @map("restaurant_id") @db.Uuid
  email        String // Email de la personne invit√©e
  roleId       String           @map("role_id") @db.Uuid // R√©f√©rence au r√¥le personnalis√©
  token        String           @unique // Token unique pour le lien d'invitation
  status       InvitationStatus @default(pending)
  invitedBy    String           @map("invited_by") @db.Uuid // ID de l'admin qui a invit√©
  expiresAt    DateTime         @map("expires_at") // Date d'expiration (7 jours)
  acceptedAt   DateTime?        @map("accepted_at") // Date d'acceptation
  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")

  // Relations
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@index([restaurantId, status])
  @@index([email])
  @@index([token])
  @@map("invitations")
}

model Subscription {
  id                String             @id @default(uuid()) @db.Uuid
  restaurantId      String             @unique @map("restaurant_id") @db.Uuid
  plan              SubscriptionPlan
  status            SubscriptionStatus @default(trial)
  
  // Dates importantes
  trialStartsAt     DateTime           @map("trial_starts_at")
  trialEndsAt       DateTime           @map("trial_ends_at")
  currentPeriodStart DateTime?         @map("current_period_start")
  currentPeriodEnd   DateTime?         @map("current_period_end")
  
  // Informations plan
  monthlyPrice      Int                @map("monthly_price") // Prix en FCFA
  billingCycle      Int                @default(1) @map("billing_cycle") // 1, 3, 6, 12 mois
  
  // Limites du plan
  maxTables         Int?               @map("max_tables") // null = illimit√©
  maxUsers          Int                @map("max_users")
  hasStockManagement Boolean           @default(false) @map("has_stock_management")
  hasAdvancedStats   Boolean           @default(false) @map("has_advanced_stats")
  hasDataExport      Boolean           @default(false) @map("has_data_export")
  hasMobilePayment   Boolean           @default(false) @map("has_mobile_payment")
  hasMultiRestaurants Boolean          @default(false) @map("has_multi_restaurants")
  
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  
  // Relations
  restaurant        Restaurant         @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  payments          SubscriptionPayment[]
  emailLogs         SubscriptionEmailLog[]
  
  @@index([restaurantId, status])
  @@index([status, currentPeriodEnd])
  @@map("subscriptions")
}

model SubscriptionPayment {
  id              String                      @id @default(uuid()) @db.Uuid
  subscriptionId  String                      @map("subscription_id") @db.Uuid
  restaurantId    String                      @map("restaurant_id") @db.Uuid
  
  amount          Int                         // Montant en FCFA
  method          SubscriptionPaymentMethod
  status          SubscriptionPaymentStatus   @default(pending)
  billingCycle    Int                         @map("billing_cycle") // Nombre de mois pay√©s
  
  // Informations paiement manuel
  proofUrl        String?                     @map("proof_url") // URL de la preuve de paiement (capture)
  manualNotes     String?                     @map("manual_notes") // Notes admin
  validatedBy     String?                     @map("validated_by") @db.Uuid // ID du super admin
  validatedAt     DateTime?                   @map("validated_at")
  
  // Informations paiement mobile (V2)
  transactionId   String?                     @map("transaction_id") // ID transaction Mobile Money
  phoneNumber     String?                     @map("phone_number")
  provider        String?                     // "airtel" ou "moov"

  errorMessage String? @map("error_message")
  
  // Dates
  paidAt          DateTime?                   @map("paid_at")
  expiresAt       DateTime                    @map("expires_at") // Date de fin de la p√©riode pay√©e
  createdAt       DateTime                    @default(now()) @map("created_at")
  updatedAt       DateTime                    @updatedAt @map("updated_at")
  
  // Relations
  subscription    Subscription                @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  restaurant      Restaurant                  @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  @@index([subscriptionId])
  @@index([restaurantId, status])
  @@index([status, createdAt])
  @@map("subscription_payments")
}

// Nouveau model pour tracer les emails envoy√©s
model SubscriptionEmailLog {
  id              String   @id @default(uuid()) @db.Uuid
  subscriptionId  String   @map("subscription_id") @db.Uuid
  restaurantId    String   @map("restaurant_id") @db.Uuid
  
  emailType       String   @map("email_type")  // "trial_7_days", "trial_3_days", "trial_1_day", etc.
  recipientEmail  String   @map("recipient_email")
  
  sentAt          DateTime @default(now()) @map("sent_at")
  status          String   // "sent", "failed", "bounced"
  errorMessage    String?  @map("error_message")
  
  // Relations
  subscription    Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  restaurant      Restaurant   @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  @@index([subscriptionId, emailType])
  @@index([restaurantId, sentAt])
  @@map("subscription_email_logs")
}